<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>CM O/N 5B ‚Äì BLACKPINK QUIZ</title>

  <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="CM O/N 5B" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <link rel="apple-touch-icon" href="icon.png" />

  <style>
    :root {
      --pink: #ff4da6;
      --pink-soft: #ff99cc;
      --bg: #08040b;
      --card-bg: #15101b;
      --accent: #ffe6f5;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
      background: radial-gradient(circle at top, #2a1038 0, #08040b 40%, #000 100%);
      overflow-x: hidden;
      padding: 0;
    }

    /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–≤–µ—Ç–æ–≤–æ–π —Ñ–æ–Ω */
    body::before {
      content: "";
      position: fixed;
      inset: -50px;
      background:
        radial-gradient(circle at 0 0, rgba(255, 77, 166, 0.25), transparent 60%),
        radial-gradient(circle at 100% 0, rgba(160, 100, 255, 0.25), transparent 60%);
      opacity: 0.7;
      mix-blend-mode: screen;
      animation: bgMove 14s linear infinite alternate;
      pointer-events: none;
      z-index: -1;
    }

    @keyframes bgMove {
      0% { transform: translate3d(0, 0, 0); }
      100% { transform: translate3d(-40px, 40px, 0); }
    }

    .app {
      max-width: 980px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      text-align: center;
      margin-bottom: 16px;
    }

    .logo-title {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--pink);
      text-shadow: 0 0 12px rgba(255, 77, 166, 0.9);
    }

    .subtitle {
      font-size: 14px;
      color: #ddd;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 13px;
      color: var(--accent);
      width: 100%;
      max-width: 960px;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(10, 5, 15, 0.85);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-strong {
      border-color: var(--pink);
      color: var(--pink-soft);
    }

    select {
      background: #120b18;
      color: #fff;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.24);
      padding: 4px 10px;
      font-size: 13px;
      outline: none;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(240px, 1.1fr);
      gap: 16px;
    }

    @media (max-width: 800px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: linear-gradient(135deg, rgba(255, 77, 166, 0.08), rgba(17, 17, 17, 0.96));
      border-radius: 18px;
      padding: 16px 14px 18px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 0 18px rgba(0, 0, 0, 0.85);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -60%;
      background-image:
        radial-gradient(circle, rgba(255, 255, 255, 0.18) 0, transparent 55%),
        radial-gradient(circle, rgba(255, 77, 166, 0.24) 0, transparent 60%);
      mix-blend-mode: screen;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
    }

    .card.glitter::before {
      opacity: 1;
      animation: glitter 0.5s ease-out forwards;
    }

    @keyframes glitter {
      0% { transform: translate(-10%, -10%) scale(1); opacity: 1; }
      100% { transform: translate(10%, 10%) scale(1.15); opacity: 0; }
    }

    .question-meta {
      font-size: 12px;
      color: var(--accent);
      margin-bottom: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }

    .rule-link {
      color: var(--pink-soft);
      text-decoration: underline;
      cursor: pointer;
      font-size: 12px;
    }

    .question-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .options {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .option-btn {
      background: rgba(12, 8, 18, 0.95);
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      padding: 10px 14px;
      color: #fff;
      font-size: 15px;
      text-align: left;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: transform 0.12s, box-shadow 0.12s, border-color 0.12s, background 0.12s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .option-btn span.key {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      margin-right: 8px;
      font-size: 13px;
      color: var(--pink-soft);
    }

    .option-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 10px rgba(255, 77, 166, 0.5);
      border-color: var(--pink);
    }

    .option-btn.correct {
      background: linear-gradient(90deg, #158a5b, #19b36f);
      border-color: #19b36f;
    }

    .option-btn.incorrect {
      background: linear-gradient(90deg, #b31255, #f5426c);
      border-color: #ff8a80;
    }

    .option-btn.disabled {
      pointer-events: none;
      opacity: 0.85;
    }

    .feedback {
      margin-top: 10px;
      font-size: 14px;
      text-align: left;
      padding: 10px 12px;
      border-radius: 12px;
    }

    .feedback.correct {
      background: rgba(25, 178, 111, 0.15);
      border: 1px solid #19b36f;
    }

    .feedback.incorrect {
      background: rgba(244, 67, 54, 0.18);
      border: 1px solid #ff8a80;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: rgba(12, 8, 18, 0.95);
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .btn-primary {
      border-color: var(--pink);
      background: linear-gradient(90deg, #ff4da6, #ff99cc);
      color: #1b0512;
      font-weight: 600;
      box-shadow: 0 0 12px rgba(255, 77, 166, 0.7);
    }

    .btn-primary:disabled {
      opacity: 0.4;
      box-shadow: none;
      cursor: default;
    }

    .stats {
      font-size: 13px;
      color: var(--accent);
      margin-top: 6px;
    }

    .sidebar-section {
      margin-bottom: 14px;
    }

    .sidebar-title {
      font-size: 14px;
      margin-bottom: 6px;
      color: var(--pink-soft);
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    .topic-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(10, 6, 16, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.12);
      margin-bottom: 6px;
    }

    .topic-header {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
    }

    .topic-progress-bar {
      height: 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.12);
      overflow: hidden;
    }

    .topic-progress-fill {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #19b36f, #8bc34a);
      transition: width 0.2s;
    }

    .topic-badge-bad {
      color: #ff8a80;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 4px;
    }

    .history-table th,
    .history-table td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      text-align: left;
    }

    .history-table th {
      font-weight: 600;
      color: var(--pink-soft);
    }

    .history-empty {
      font-size: 12px;
      color: #aaa;
      margin-top: 4px;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø—Ä–∞–≤–∏–ª–æ–º */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      max-width: 520px;
      width: 92%;
      background: #120a18;
      border-radius: 18px;
      padding: 16px 18px 18px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.85);
      text-align: left;
    }

    .modal h3 {
      margin-top: 0;
      margin-bottom: 8px;
      color: var(--pink-soft);
    }

    .modal p {
      font-size: 14px;
      margin: 4px 0;
    }

    .link-rule {
      color: var(--pink-soft);
      text-decoration: underline;
      font-size: 13px;
    }

    /* ======== MOBILE OPTIMIZATION ========= */
    @media (max-width: 600px) {
      body {
        padding: 10px 0;
      }

      .app {
        padding: 10px 10px 24px;
      }

      .logo-title {
        font-size: 18px;
      }

      .subtitle {
        font-size: 12px;
      }

      .top-bar {
        flex-direction: column;
        align-items: stretch;
        font-size: 12px;
      }

      .badge {
        width: 100%;
        justify-content: center;
      }

      main {
        grid-template-columns: 1fr !important;
      }

      .card {
        padding: 12px;
      }

      .question-text {
        font-size: 16px;
        line-height: 1.4;
      }

      .option-btn {
        font-size: 14px;
        padding: 10px;
      }

      .option-btn span.key {
        width: 20px;
        height: 20px;
        font-size: 12px;
      }

      .feedback {
        font-size: 13px;
        padding: 8px;
      }

      #restartBtn,
      #nextBtn {
        width: 100%;
        font-size: 14px;
        padding: 10px;
        justify-content: center;
      }

      .sidebar-title {
        font-size: 13px;
      }

      .history-table {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo-title">CM O/N 5B ‚Äì BLACKPINK QUIZ</div>
    <div class="subtitle">Czƒô≈õci mowy odmienne i nieodmienne ¬∑ klasa 5B</div>
    <div class="top-bar">
      <div class="badge badge-strong">Tryb: nauka + powt√≥rka</div>
      <div class="badge">
        Test:
        <select id="testSelect"></select>
      </div>
      <div class="badge" id="questionCounter">Pytanie 1 / 1</div>
      <div class="badge" id="accuracyBadge">Skuteczno≈õƒá: 0%</div>
    </div>
  </header>

  <main>
    <section class="card" id="questionCard">
      <div class="question-meta">
        <span id="topicLabel">Temat: ‚Äî</span>
        <span class="rule-link" id="ruleBtn">üìñ Zobacz zasadƒô</span>
      </div>
      <div class="question-text" id="questionText">Wczytywanie‚Ä¶</div>
      <div class="options" id="optionsContainer"></div>
      <div id="feedbackContainer"></div>
      <div class="controls">
        <button class="btn" id="restartBtn">üîÅ Zacznij test od nowa</button>
        <button class="btn btn-primary" id="nextBtn" disabled>Nastƒôpne pytanie ‚Üí</button>
      </div>
      <div class="stats" id="globalStats"></div>
    </section>

    <aside class="card">
      <div class="sidebar-section">
        <div class="sidebar-title">Postƒôp wg tematu</div>
        <div id="topicsSummary"></div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">Historia pr√≥b (lokalnie)</div>
        <div id="historyContainer"></div>
      </div>
    </aside>
  </main>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —Å –ø—Ä–∞–≤–∏–ª–æ–º -->
<div class="modal-backdrop" id="ruleModal">
  <div class="modal">
    <h3 id="ruleTitle">Zasada</h3>
    <p id="ruleText"></p>
    <p><a id="ruleLink" class="link-rule" href="#" target="_blank" rel="noopener">Otw√≥rz materia≈Ç w nowej karcie</a></p>
    <button class="btn btn-primary" onclick="closeRuleModal()">Zamknij</button>
  </div>
</div>

<script>
  // ====== –ó–í–£–ö–ò (–¥–æ–ª–∂–Ω—ã –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å index.html; –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ –±—É–¥–µ—Ç –∑–≤—É–∫–∞) ======
  const sfx = {
    correct: new Audio('bp-correct.mp3'),
    wrong:   new Audio('bp-wrong.mp3'),
    click:   new Audio('bp-click.mp3')
  };

  function safePlay(audio) {
    if (!audio) return;
    audio.currentTime = 0;
    audio.play().catch(() => {});
  }

  // ====== –î–ê–ù–ù–´–ï –¢–ï–°–¢–û–í ======
  const tests = [
    {
      id: 'cm-on-5b',
      name: 'Czƒô≈õci mowy odmienne i nieodmienne 5B',
      topics: [
        {
          id: 'rzeczownik',
          name: 'Rzeczownik',
          ruleTitle: 'Rzeczownik ‚Äì przypomnienie i uzupe≈Çnienie',
          ruleText: 'Rzeczownik to czƒô≈õƒá mowy, kt√≥ra nazywa osoby, zwierzƒôta, ro≈õliny, przedmioty, miejsca i pojƒôcia. Odpowiada na pytania: kto? co?',
          ruleUrl: 'https://epodreczniki.pl/a/rzeczownik/D2FQe8tts'
        },
        {
          id: 'przymiotnik',
          name: 'Przymiotnik',
          ruleTitle: 'Przymiotnik ‚Äì stopniowanie i u≈ºycie',
          ruleText: 'Przymiotnik nazywa cechy os√≥b, zwierzƒÖt i przedmiot√≥w. Odpowiada na pytania: jaki? jaka? jakie? Mo≈ºna go stopniowaƒá: mi≈Çy ‚Äì milszy ‚Äì najmilszy.',
          ruleUrl: 'https://epodreczniki.pl/a/przymiotnik/D1BtLqN9I'
        },
        {
          id: 'czasownik',
          name: 'Czasownik',
          ruleTitle: 'Czasownik ‚Äì formy osobowe i nieosobowe',
          ruleText: 'Czasownik nazywa czynno≈õci i stany. Odpowiada na pytania: co robi? co siƒô dzieje? Ma formy osobowe i nieosobowe (np. bezokolicznik).',
          ruleUrl: 'https://epodreczniki.pl/a/czasownik/Dm1fH4nL0'
        },
        {
          id: 'przyslowek',
          name: 'Przys≈Ç√≥wek',
          ruleTitle: 'Przys≈Ç√≥wek ‚Äì jak? gdzie? kiedy?',
          ruleText: 'Przys≈Ç√≥wek okre≈õla czasownik, przymiotnik lub inny przys≈Ç√≥wek. Odpowiada na pytania: jak? gdzie? kiedy?',
          ruleUrl: 'https://epodreczniki.pl/a/przyslowek/D12G6JZ1n'
        },
        {
          id: 'liczebnik',
          name: 'Liczebnik',
          ruleTitle: 'Liczebnik ‚Äì ilo≈õƒá i kolejno≈õƒá',
          ruleText: 'Liczebnik okre≈õla ilo≈õƒá, liczbƒô lub kolejno≈õƒá obiekt√≥w, np. trzy, piƒôƒá, piƒÖty.',
          ruleUrl: 'https://epodreczniki.pl/a/liczebnik/D1J2i2wsG'
        },
        {
          id: 'przyimek',
          name: 'Przyimek',
          ruleTitle: 'Przyimek ‚Äì wyra≈ºenia przyimkowe',
          ruleText: 'Przyimek ≈ÇƒÖczy siƒô z rzeczownikiem, tworzƒÖc wyra≈ºenia przyimkowe, np. na stole, pod domem, do szko≈Çy.',
          ruleUrl: 'https://epodreczniki.pl/a/przyimek/D1XfB5Scq'
        },
        {
          id: 'spojnik',
          name: 'Sp√≥jnik',
          ruleTitle: 'Sp√≥jnik ‚Äì ≈ÇƒÖczenie wyraz√≥w i zda≈Ñ',
          ruleText: 'Sp√≥jniki ≈ÇƒÖczƒÖ wyrazy i zdania, np. i, oraz, ale, lecz, wiƒôc.',
          ruleUrl: 'https://epodreczniki.pl/a/spojnik/D17mkf9Wb'
        }
      ],
      questions: [
        // Rzeczownik
        {
          topicId: 'rzeczownik',
          q: 'Rzeczownik to czƒô≈õƒá mowy, kt√≥ra nazywa:',
          options: ['cechy', 'czynno≈õci', 'osoby, zwierzƒôta i zjawiska', 'liczby'],
          answer: 2,
          expl: 'Rzeczownik nazywa osoby, zwierzƒôta, ro≈õliny, przedmioty, miejsca i pojƒôcia.'
        },
        {
          topicId: 'rzeczownik',
          q: 'Kt√≥re z poni≈ºszych jest rzeczownikiem pospolitym?',
          options: ['Wis≈Ça', 'Europa', 'dziewczynka', 'Marta'],
          answer: 2,
          expl: 'Rzeczownik pospolity to nazwa og√≥lna, np. ‚Äûdziewczynka‚Äù.'
        },
        {
          topicId: 'rzeczownik',
          q: 'Kt√≥re s≈Çowo jest rzeczownikiem w≈Çasnym?',
          options: ['ksiƒÖ≈ºka', 'pies', 'Adam', 'lekarz'],
          answer: 2,
          expl: 'Rzeczowniki w≈Çasne zapisujemy wielkƒÖ literƒÖ, np. ‚ÄûAdam‚Äù.'
        },
        {
          topicId: 'rzeczownik',
          q: 'W kt√≥rym wyra≈ºeniu rzeczownik wystƒôpuje w liczbie mnogiej?',
          options: ['dom', 'dziecko', 'ksiƒÖ≈ºki', 'drzewo'],
          answer: 2,
          expl: '‚ÄûKsiƒÖ≈ºki‚Äù to liczba mnoga rzeczownika ‚ÄûksiƒÖ≈ºka".'
        },

        // Przymiotnik
        {
          topicId: 'przymiotnik',
          q: 'Przymiotnik okre≈õla zwykle:',
          options: ['liczbƒô', 'nazwƒô osoby', 'cechƒô', 'miejsce'],
          answer: 2,
          expl: 'Przymiotnik nazywa cechy, np. czerwony, wysoki, weso≈Çy.'
        },
        {
          topicId: 'przymiotnik',
          q: 'Wska≈º przymiotnik:',
          options: ['szybko', 'czerwony', 'dziewczynka', 'biega'],
          answer: 1,
          expl: '‚ÄûCzerwony‚Äù to przymiotnik ‚Äì okre≈õla kolor (cechƒô).'
        },
        {
          topicId: 'przymiotnik',
          q: 'Jak poprawnie stopniujemy przymiotnik ‚Äûmi≈Çy‚Äù?',
          options: ['mi≈Çy ‚Äì milszy ‚Äì najmilszy', 'mi≈Çy ‚Äì bardziej mi≈Çy ‚Äì najbardziej mi≈Çy', 'mi≈Çy ‚Äì najmilszy ‚Äì milszy', 'mi≈Çy ‚Äì milszy ‚Äì bardziej mi≈Çy'],
          answer: 0,
          expl: 'Poprawne stopniowanie: mi≈Çy ‚Äì milszy ‚Äì najmilszy.'
        },

        // Czasownik
        {
          topicId: 'czasownik',
          q: 'Czasownik to czƒô≈õƒá mowy, kt√≥ra nazywa:',
          options: ['cechy', 'czynno≈õci i stany', 'przedmioty', 'uczucia'],
          answer: 1,
          expl: 'Czasownik nazywa czynno≈õci i stany, np. czytaƒá, spaƒá, my≈õleƒá.'
        },
        {
          topicId: 'czasownik',
          q: 'Kt√≥ra forma jest nieosobowƒÖ formƒÖ czasownika?',
          options: ['poszed≈Ç', 'p≈Çywaƒá', 'idzie', 'siedzƒÖ'],
          answer: 1,
          expl: 'Bezokolicznik (np. ‚Äûp≈Çywaƒá‚Äù) jest formƒÖ nieosobowƒÖ czasownika.'
        },
        {
          topicId: 'czasownik',
          q: 'Do czego s≈Çu≈ºy tryb rozkazujƒÖcy?',
          options: ['opisywania przesz≈Ço≈õci', 'wyra≈ºania nakaz√≥w i pr√≥≈õb', 'opisywania cech', 'zadawania pyta≈Ñ'],
          answer: 1,
          expl: 'Tryb rozkazujƒÖcy s≈Çu≈ºy do wydawania polece≈Ñ i pr√≥≈õb, np. ‚ÄûCzytaj!‚Äù, ‚ÄûUsiƒÖd≈∫!‚Äù.'
        },

        // Przys≈Ç√≥wek
        {
          topicId: 'przyslowek',
          q: 'Przys≈Ç√≥wek okre≈õla zwykle:',
          options: ['czasownik', 'rzeczownik', 'liczebnik', 'zaimek'],
          answer: 0,
          expl: 'Przys≈Ç√≥wek najczƒô≈õciej okre≈õla czasownik: jak? gdzie? kiedy?'
        },
        {
          topicId: 'przyslowek',
          q: 'Wska≈º przys≈Ç√≥wek:',
          options: ['czerwony', 'wczoraj', 'dziewczynka', 'smaczny'],
          answer: 1,
          expl: '‚ÄûWczoraj‚Äù odpowiada na pytanie ‚Äûkiedy?‚Äù ‚Äì to przys≈Ç√≥wek.'
        },

        // Liczebnik
        {
          topicId: 'liczebnik',
          q: 'Liczebnik okre≈õla:',
          options: ['tylko kolor', 'cechƒô osoby', 'liczbƒô, ilo≈õƒá lub kolejno≈õƒá', 'rodzaj rzeczownika'],
          answer: 2,
          expl: 'Liczebnik okre≈õla ilo≈õƒá lub kolejno≈õƒá, np. trzy, piƒôƒá, piƒÖty.'
        },
        {
          topicId: 'liczebnik',
          q: 'Wska≈º liczebnik porzƒÖdkowy:',
          options: ['piƒôƒá', 'piƒÖty', 'piƒÖtka', 'piƒôcioro'],
          answer: 1,
          expl: '‚ÄûPiƒÖty‚Äù oznacza kolejno≈õƒá ‚Äì to liczebnik porzƒÖdkowy.'
        },

        // Przyimek
        {
          topicId: 'przyimek',
          q: 'Kt√≥re s≈Çowo jest przyimkiem?',
          options: ['pod', 'bardzo', 'mama', 'niebieski'],
          answer: 0,
          expl: '‚ÄûPod‚Äù to przyimek ‚Äì tworzy wyra≈ºenia przyimkowe, np. pod sto≈Çem.'
        },
        {
          topicId: 'przyimek',
          q: 'W kt√≥rym wyra≈ºeniu poprawnie u≈ºyto przyimka?',
          options: ['idƒô dom', 'idƒô do domu', 'idƒô domem', 'idƒô domowi'],
          answer: 1,
          expl: 'Poprawna forma: ‚Äûidƒô do domu‚Äù.'
        },

        // Sp√≥jnik
        {
          topicId: 'spojnik',
          q: 'Sp√≥jnik to czƒô≈õƒá mowy, kt√≥ra:',
          options: ['nazywa osoby', 'okre≈õla ilo≈õƒá', '≈ÇƒÖczy wyrazy i zdania', 'okre≈õla cechy'],
          answer: 2,
          expl: 'Sp√≥jnik ≈ÇƒÖczy wyrazy i zdania, np. i, ale, lecz, lub.'
        },
        {
          topicId: 'spojnik',
          q: 'Wska≈º sp√≥jnik:',
          options: ['przez', 'oraz', 'w', 'pod'],
          answer: 1,
          expl: '‚ÄûOraz‚Äù to sp√≥jnik ≈ÇƒÖczƒÖcy wyrazy i zdania.'
        },
        {
          topicId: 'spojnik',
          q: 'Kt√≥re zdanie zawiera sp√≥jnik przeciwstawny?',
          options: [
            'Lubiƒô psy i koty.',
            'Chcia≈Çem i≈õƒá, ale pada≈Ço.',
            'Poszed≈Çem do kina i na lody.',
            'Kupi≈Çem chleb oraz mas≈Ço.'
          ],
          answer: 1,
          expl: '‚ÄûAle‚Äù jest sp√≥jnikiem przeciwstawnym.'
        }
        // => –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–∞–ª—å—à–µ –¥–æ–ø–æ–ª–Ω—è—Ç—å –¥–æ 50 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —Ç–æ–º—É –∂–µ —à–∞–±–ª–æ–Ω—É
      ]
    }
  ];

  // ====== –°–û–°–¢–û–Ø–ù–ò–ï ======
  const state = {
    currentTestId: tests[0].id,
    currentIndex: 0,
    answered: false,
    correctCount: 0,
    perTopic: {},
    historyKey: 'bpQuizHistory_v1'
  };

  // DOM-—ç–ª–µ–º–µ–Ω—Ç—ã
  const testSelectEl = document.getElementById('testSelect');
  const questionTextEl = document.getElementById('questionText');
  const optionsEl = document.getElementById('optionsContainer');
  const feedbackEl = document.getElementById('feedbackContainer');
  const topicLabelEl = document.getElementById('topicLabel');
  const topicsSummaryEl = document.getElementById('topicsSummary');
  const questionCounterEl = document.getElementById('questionCounter');
  const accuracyBadgeEl = document.getElementById('accuracyBadge');
  const globalStatsEl = document.getElementById('globalStats');
  const historyContainerEl = document.getElementById('historyContainer');
  const questionCardEl = document.getElementById('questionCard');
  const nextBtn = document.getElementById('nextBtn');
  const restartBtn = document.getElementById('restartBtn');
  const ruleBtn = document.getElementById('ruleBtn');

  const ruleModal = document.getElementById('ruleModal');
  const ruleTitleEl = document.getElementById('ruleTitle');
  const ruleTextEl = document.getElementById('ruleText');
  const ruleLinkEl = document.getElementById('ruleLink');

  function getCurrentTest() {
    return tests.find(t => t.id === state.currentTestId);
  }

  function getCurrentQuestion() {
    return getCurrentTest().questions[state.currentIndex];
  }

  function getTopicById(id) {
    return getCurrentTest().topics.find(t => t.id === id);
  }

  function initTestSelect() {
    tests.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = t.name;
      testSelectEl.appendChild(opt);
    });
    testSelectEl.value = state.currentTestId;
    testSelectEl.addEventListener('change', () => {
      safePlay(sfx.click);
      state.currentTestId = testSelectEl.value;
      resetTest();
    });
  }

  function resetPerTopic() {
    const test = getCurrentTest();
    state.perTopic = {};
    test.topics.forEach(topic => {
      state.perTopic[topic.id] = { correct: 0, total: 0 };
    });
  }

  function resetTest() {
    resetPerTopic();
    state.currentIndex = 0;
    state.correctCount = 0;
    state.answered = false;
    renderQuestion();
    updateSidebar();
    updateHistory();
  }

  function renderQuestion() {
    const test = getCurrentTest();
    const total = test.questions.length;
    const q = getCurrentQuestion();
    const topic = getTopicById(q.topicId);

    // –≥–ª–∏—Ç—Ç–µ—Ä-–∞–Ω–∏–º–∞—Ü–∏—è
    questionCardEl.classList.remove('glitter');
    void questionCardEl.offsetWidth;
    questionCardEl.classList.add('glitter');

    questionTextEl.textContent = q.q;
    topicLabelEl.textContent = `Temat: ${topic.name}`;
    feedbackEl.innerHTML = '';
    nextBtn.disabled = true;
    state.answered = false;

    optionsEl.innerHTML = '';
    const letters = ['A', 'B', 'C', 'D'];
    q.options.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.innerHTML = `<span class="key">${letters[i]}</span> ${opt}`;
      btn.addEventListener('click', () => handleAnswer(i));
      optionsEl.appendChild(btn);
    });

    questionCounterEl.textContent = `Pytanie ${state.currentIndex + 1} / ${total}`;

    const answeredTotal = state.currentIndex;
    const acc = answeredTotal > 0 ? Math.round((state.correctCount / answeredTotal) * 100) : 0;
    accuracyBadgeEl.textContent = `Skuteczno≈õƒá: ${acc}%`;
    globalStatsEl.textContent = `Poprawnych odpowiedzi: ${state.correctCount} z ${answeredTotal} (na razie sprawdzonych pyta≈Ñ).`;

    ruleBtn.onclick = () => openRuleModal(topic);
  }

  function handleAnswer(index) {
    if (state.answered) return;
    state.answered = true;
    safePlay(sfx.click);

    const q = getCurrentQuestion();
    const topic = getTopicById(q.topicId);
    const optionButtons = optionsEl.querySelectorAll('.option-btn');

    optionButtons.forEach(btn => btn.classList.add('disabled'));
    optionButtons[q.answer].classList.add('correct');

    let correct = false;
    if (index === q.answer) {
      correct = true;
      state.correctCount++;
      safePlay(sfx.correct);
    } else {
      optionButtons[index].classList.add('incorrect');
      safePlay(sfx.wrong);
    }

    state.perTopic[q.topicId].total++;
    if (correct) state.perTopic[q.topicId].correct++;

    const fbDiv = document.createElement('div');
    fbDiv.className = 'feedback ' + (correct ? 'correct' : 'incorrect');
    fbDiv.innerHTML = `<b>${correct ? '‚úî Dobrze!' : '‚úñ Niepoprawnie.'}</b><br>${q.expl}`;
    feedbackEl.innerHTML = '';
    feedbackEl.appendChild(fbDiv);

    nextBtn.disabled = false;

    const test = getCurrentTest();
    const total = test.questions.length;
    const answeredTotal = state.currentIndex + 1;
    const acc = Math.round((state.correctCount / answeredTotal) * 100);
    accuracyBadgeEl.textContent = `Skuteczno≈õƒá: ${acc}%`;
    globalStatsEl.textContent = `Poprawnych odpowiedzi: ${state.correctCount} z ${answeredTotal}.`;

    updateSidebar();

    if (answeredTotal === total) {
      saveAttempt();
    }
  }

  function nextQuestion() {
    const test = getCurrentTest();
    if (state.currentIndex < test.questions.length - 1) {
      safePlay(sfx.click);
      state.currentIndex++;
      state.answered = false;
      renderQuestion();
    } else {
      safePlay(sfx.click);
      const total = test.questions.length;
      const acc = Math.round((state.correctCount / total) * 100);
      feedbackEl.innerHTML =
        `<div class="feedback correct"><b>Koniec testu!</b><br>` +
        `Tw√≥j wynik: ${state.correctCount} / ${total} (${acc}%).</div>`;
      nextBtn.disabled = true;
    }
  }

  function openRuleModal(topic) {
    ruleTitleEl.textContent = topic.ruleTitle;
    ruleTextEl.textContent = topic.ruleText;
    ruleLinkEl.href = topic.ruleUrl;
    ruleModal.classList.add('show');
  }

  function closeRuleModal() {
    ruleModal.classList.remove('show');
  }
  window.closeRuleModal = closeRuleModal;

  function updateSidebar() {
    const test = getCurrentTest();
    topicsSummaryEl.innerHTML = '';
    test.topics.forEach(topic => {
      const data = state.perTopic[topic.id] || { correct: 0, total: 0 };
      const total = data.total || 0;
      const correct = data.correct || 0;
      const pct = total > 0 ? Math.round((correct / total) * 100) : 0;

      const row = document.createElement('div');
      row.className = 'topic-row';

      const header = document.createElement('div');
      header.className = 'topic-header';
      const left = document.createElement('span');
      left.textContent = topic.name;
      const right = document.createElement('span');
      right.innerHTML =
        total === 0
          ? '<span class="topic-badge-bad">brak pr√≥b</span>'
          : (pct >= 80
            ? `${pct}% ‚úì`
            : `<span class="topic-badge-bad">${pct}% ‚Äì warto powt√≥rzyƒá</span>`);

      header.appendChild(left);
      header.appendChild(right);

      const bar = document.createElement('div');
      bar.className = 'topic-progress-bar';
      const fill = document.createElement('div');
      fill.className = 'topic-progress-fill';
      fill.style.width = pct + '%';
      bar.appendChild(fill);

      row.appendChild(header);
      row.appendChild(bar);
      topicsSummaryEl.appendChild(row);
    });
  }

  function saveAttempt() {
    const test = getCurrentTest();
    const total = test.questions.length;
    const acc = Math.round((state.correctCount / total) * 100);
    const perTopicSummary = {};
    Object.keys(state.perTopic).forEach(id => {
      const data = state.perTopic[id];
      const tTotal = data.total || 0;
      const tAcc = tTotal > 0 ? Math.round((data.correct / tTotal) * 100) : 0;
      perTopicSummary[id] = { acc: tAcc, total: tTotal };
    });

    const attempt = {
      testId: test.id,
      timestamp: new Date().toISOString(),
      score: state.correctCount,
      total: total,
      acc,
      perTopic: perTopicSummary
    };

    let history = [];
    try {
      const raw = localStorage.getItem(state.historyKey);
      if (raw) history = JSON.parse(raw);
    } catch (_) {}

    history.push(attempt);
    localStorage.setItem(state.historyKey, JSON.stringify(history));
    updateHistory();
  }

  function updateHistory() {
    let history = [];
    try {
      const raw = localStorage.getItem(state.historyKey);
      if (raw) history = JSON.parse(raw);
    } catch (_) {}

    const test = getCurrentTest();
    const filtered = history.filter(h => h.testId === test.id).slice(-8).reverse();

    if (filtered.length === 0) {
      historyContainerEl.innerHTML =
        '<div class="history-empty">Brak zapisanych pr√≥b. Uko≈Ñcz test, aby zapisaƒá wynik.</div>';
      return;
    }

    const table = document.createElement('table');
    table.className = 'history-table';
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr><th>Data</th><th>Wynik</th><th>Skuteczno≈õƒá</th></tr>';
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    filtered.forEach(attempt => {
      const tr = document.createElement('tr');
      const date = new Date(attempt.timestamp);
      const dateStr =
        date.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' }) +
        ' ' +
        date.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

      const tdDate = document.createElement('td');
      tdDate.textContent = dateStr;

      const tdScore = document.createElement('td');
      tdScore.textContent = `${attempt.score}/${attempt.total}`;

      const tdAcc = document.createElement('td');
      tdAcc.textContent = attempt.acc + '%';

      tr.appendChild(tdDate);
      tr.appendChild(tdScore);
      tr.appendChild(tdAcc);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    historyContainerEl.innerHTML = '';
    historyContainerEl.appendChild(table);
  }

  nextBtn.addEventListener('click', nextQuestion);
  restartBtn.addEventListener('click', () => {
    safePlay(sfx.click);
    resetTest();
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  initTestSelect();
  resetTest();

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è PWA
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(() => {});
  }
</script>
</body>
</html>
